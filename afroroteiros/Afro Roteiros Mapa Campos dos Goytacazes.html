<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Afro-Roteiros Campos dos Goytacazes - Mapa Sat√©lite Art√≠stico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* RESET E CONFIGURA√á√ïES B√ÅSICAS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1e0e 0%, #0a0d07 100%);
            overflow: hidden;
        }
        
        /* CONTAINER PRINCIPAL COM HEADER FIXO */
        .main-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* ============================= */
        /* CABE√áALHO FIXO - NOVA ABORDAGEM */
        /* ============================= */
        .map-header {
            background: linear-gradient(135deg, rgba(232, 119, 34, 0.98) 0%, rgba(210, 105, 30, 0.98) 100%);
            color: white;
            padding: 12px 15px 12px 60px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255,255,255,0.2);
            z-index: 1000;
            flex-shrink: 0;
            position: relative;
        }
        
        .map-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            gap: 10px;
        }
        
        .map-title {
            flex: 1;
            min-width: 0;
        }
        
        .map-title h1 {
            font-size: clamp(1.2rem, 4vw, 1.6rem);
            margin: 0;
            font-weight: 700;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .map-title p {
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            opacity: 0.9;
            margin: 4px 0 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }
        
        /* Bot√£o de voltar para o site */
        .back-to-site-btn {
            position: absolute;
            top: 12px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            text-decoration: none;
        }
        
        .back-to-site-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        @media (max-width: 480px) {
            .back-to-site-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
        }
        
        /* Bot√µes de controle */
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .control-btn.active {
            background: white;
            color: #e87722;
        }
        
        /* Bot√£o da trilha */
        .trail-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        @media (max-width: 480px) {
            .trail-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .trail-btn span {
                display: none;
            }
        }
        
        @media (min-width: 768px) {
            .trail-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
        
        .trail-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* √çcone da trilha */
        .trail-icon {
            display: flex;
            gap: 3px;
            align-items: center;
            height: 20px;
        }
        
        .footprint {
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: brightness(0) invert(1);
        }
        
        .footprint.left {
            background-image: url('https://static.wixstatic.com/media/44e2c7_59191b4359a04e3f8fb8cb9875fb2645~mv2.png');
            transform: rotate(-10deg);
        }
        
        .footprint.right {
            background-image: url('https://static.wixstatic.com/media/44e2c7_59191b4359a04e3f8fb8cb9875fb2645~mv2.png');
            transform: rotate(10deg) scaleX(-1);
        }
        
        .trail-btn.active .footprint {
            filter: brightness(0) invert(1) sepia(1) saturate(5) hue-rotate(5deg);
        }
        
        /* ============================= */
        /* CONTAINER DO MAPA - CORRIGIDO */
        /* ============================= */
        .map-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100vh - 70px);
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
        }
        
        @media (max-width: 768px) {
            .map-container {
                height: calc(100vh - 65px);
            }
        }
        
        @media (max-width: 480px) {
            .map-container {
                height: calc(100vh - 60px);
            }
        }
        
        /* ============================= */
        /* LINHAS TRACEJADAS PURAS - TRA√áOS ANDANDO */
        /* ============================= */
        .pure-trail-line {
            stroke: #e87722;
            stroke-width: 4;
            stroke-dasharray: 10, 15;
            stroke-linecap: round;
            fill: none;
            opacity: 0.9;
        }
        
        /* Mais vis√≠vel no mobile */
        @media (max-width: 768px) {
            .pure-trail-line {
                stroke-width: 5;
                stroke-dasharray: 8, 12;
            }
        }
        
        @media (max-width: 480px) {
            .pure-trail-line {
                stroke-width: 6;
                stroke-dasharray: 6, 10;
            }
        }
        
        /* Anima√ß√£o de tra√ßos andando */
        @keyframes dashMove {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        .pure-trail-line.animating {
            stroke-dasharray: 10, 15;
            stroke-dashoffset: 0;
            animation: dashMove 2s linear infinite;
        }
        
        /* Para dispositivos m√≥veis */
        @media (max-width: 768px) {
            .pure-trail-line.animating {
                stroke-dasharray: 8, 12;
                animation: dashMove 1.5s linear infinite;
            }
        }
        
        /* ============================= */
        /* POP-UPS */
        /* ============================= */
        .leaflet-popup-content-wrapper {
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 2px solid #e87722;
            min-width: 320px;
            max-width: 400px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            width: 100% !important;
            max-height: 500px;
            overflow-y: auto;
            padding: 0;
        }

        .custom-popup {
            text-align: left;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .popup-header {
            background: white;
            z-index: 10;
            padding: 20px 25px 15px 25px;
            border-bottom: 2px solid #f0f0f0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .popup-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .popup-title-container {
            flex: 1;
            min-width: 0;
        }

        .popup-title {
            font-size: clamp(1.2rem, 4vw, 1.6rem);
            font-weight: 700;
            margin-bottom: 8px;
            color: #3d441e;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .popup-address {
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            color: #666;
            margin-bottom: 0;
            text-align: left;
            font-style: italic;
            line-height: 1.4;
        }

        .popup-controls {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .popup-audio-btn {
            background: #e87722;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(232, 119, 34, 0.3);
        }

        .popup-audio-btn:hover {
            background: #d2691e;
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(232, 119, 34, 0.4);
        }

        .popup-audio-btn.speaking {
            background: #2ecc71;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .popup-image-container {
            padding: 0 25px;
            margin: 15px 0;
            flex: 1;
        }

        .popup-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            display: block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        @media (min-width: 768px) {
            .popup-image {
                height: 200px;
            }
        }

        .popup-body {
            padding: 0 25px 25px 25px;
        }

        .popup-description {
            font-size: clamp(0.95rem, 3vw, 1.05rem);
            margin-bottom: 0;
            color: #444;
            line-height: 1.6;
            text-align: justify;
        }

        .leaflet-popup-content::-webkit-scrollbar {
            width: 8px;
        }

        .leaflet-popup-content::-webkit-scrollbar-track {
            background: #f8f8f8;
            border-radius: 4px;
        }

        .leaflet-popup-content::-webkit-scrollbar-thumb {
            background: #e87722;
            border-radius: 4px;
        }

        /* ============================= */
        /* OUTROS COMPONENTES */
        /* ============================= */
        
        /* Painel lateral */
        .side-panel {
            position: absolute;
            top: 80px;
            left: 10px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            max-height: calc(100vh - 100px);
            overflow: hidden;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            width: calc(100% - 20px);
            max-width: 400px;
        }
        
        .side-panel.open {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Controles do mapa */
        .map-controls {
            position: absolute;
            top: 80px;
            right: 10px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 15px;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            width: calc(100% - 20px);
            max-width: 400px;
        }
        
        .map-controls.open {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Footer */
        .map-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(61, 68, 30, 0.95);
            color: white;
            padding: 8px 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            font-size: clamp(0.75rem, 2.5vw, 0.85rem);
            gap: 10px;
        }
        
        .points-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        /* Audio Descri√ß√£o */
        .page-audio-description {
            position: absolute;
            bottom: 70px;
            left: 15px;
            z-index: 1000;
        }
        
        .audio-desc-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
        }
        
        .audio-desc-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        /* Controle de voz */
        .voice-control {
            position: absolute;
            bottom: 130px;
            right: 15px;
            z-index: 1000;
        }
        
        .voice-btn {
            background: #e87722;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(232, 119, 34, 0.4);
            transition: all 0.3s;
        }
        
        .voice-btn:hover {
            background: #d2691e;
            transform: scale(1.1);
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 2px solid #e87722;
            width: 85%;
            max-width: 300px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e87722;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notifica√ß√£o */
        .notification {
            position: absolute;
            top: 90px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(100px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Modal */
        .trail-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }
        
        .trail-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .map-header {
                padding: 10px 12px 10px 55px;
            }
            
            .side-panel,
            .map-controls {
                top: 75px;
            }
            
            .notification {
                top: 85px;
                right: 10px;
                left: 10px;
            }
            
            .page-audio-description {
                bottom: 60px;
                left: 10px;
            }
            
            .voice-control {
                bottom: 120px;
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .map-header {
                padding: 8px 10px 8px 50px;
            }
            
            .side-panel,
            .map-controls {
                top: 70px;
                max-height: calc(100vh - 85px);
            }
            
            .notification {
                top: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header AGORA FIXO DE VERDADE -->
        <div class="map-header">
            <a href="https://afroroteiros.wixsite.com/afroroteiros/incio" class="back-to-site-btn" title="Voltar para o site Afro-Roteiros">
                <i class="fas fa-home"></i>
            </a>
            
            <div class="map-header-content">
                <div class="map-title">
                    <h1>Afro-Roteiros Campos dos Goytacazes</h1>
                    <p>Mapa Sat√©lite Art√≠stico - Roteiro Hist√≥rico-Cultural</p>
                </div>
                <div class="header-controls">
                    <button class="control-btn" id="toggle-points" title="Mostrar lista de pontos">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="control-btn" id="toggle-controls" title="Controles do mapa">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="trail-btn" id="show-trail" title="Registre sua trilha virtual">
                        <div class="trail-icon">
                            <div class="footprint left"></div>
                            <div class="footprint right"></div>
                        </div>
                        <span class="trail-text">Trilha</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Container do mapa - AGORA COM LAYOUT CORRETO -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Painel de pontos -->
            <div class="side-panel" id="points-panel">
                <div class="panel-header">
                    <h3>Pontos do Roteiro</h3>
                    <button class="panel-close" id="close-points-panel">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="points-list" id="points-list"></div>
            </div>
            
            <!-- Controles do mapa -->
            <div class="map-controls" id="map-controls-panel">
                <div class="control-group">
                    <h4><i class="fas fa-palette"></i> Estilo do Mapa</h4>
                    <div class="style-options" id="style-options">
                        <div class="style-option active" data-style="voyager">
                            <div class="style-icon"><i class="fas fa-satellite"></i></div>
                            <div class="style-name">Sat√©lite Art√≠stico</div>
                        </div>
                        <div class="style-option" data-style="terrain">
                            <div class="style-icon"><i class="fas fa-mountain"></i></div>
                            <div class="style-name">Relevo 3D</div>
                        </div>
                        <div class="style-option" data-style="topographic">
                            <div class="style-icon"><i class="fas fa-map"></i></div>
                            <div class="style-name">Topogr√°fico</div>
                        </div>
                        <div class="style-option" data-style="dark">
                            <div class="style-icon"><i class="fas fa-moon"></i></div>
                            <div class="style-name">Modo Escuro</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal -->
            <div class="trail-modal" id="trail-modal">
                <div class="trail-modal-content">
                    <div class="trail-modal-header">
                        <h3>Sua Trilha Virtual</h3>
                        <p>Voc√™ visitou <span id="visited-count">0</span> pontos culturais.</p>
                    </div>
                    
                    <div class="trail-stats">
                        <p><strong>Dist√¢ncia total percorrida:</strong> <span id="total-distance">0 km</span></p>
                        <p><strong>Tempo estimado:</strong> <span id="estimated-time">0 minutos</span></p>
                    </div>
                    
                    <div class="trail-points-list" id="trail-points-list"></div>
                    
                    <div class="modal-buttons">
                        <button class="modal-btn save" id="save-trail-btn">
                            <i class="fas fa-download"></i> Salvar como PDF
                        </button>
                        <button class="modal-btn cancel" id="cancel-trail-btn">
                            <i class="fas fa-times"></i> Continuar sem salvar
                        </button>
                        <button class="modal-btn continue" id="continue-trail-btn">
                            <i class="fas fa-walking"></i> Continuar Trilha
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Carregando mapa e pontos culturais...</p>
            </div>
            
            <!-- Notifica√ß√£o -->
            <div class="notification" id="notification">
                <i class="fas fa-check-circle"></i>
                <div class="notification-text" id="notification-text"></div>
            </div>
            
            <!-- Footer -->
            <div class="map-footer">
                <div class="footer-content">
                    <div class="points-counter">
                        <i class="fas fa-map-pin"></i>
                        <span id="points-count">0</span> pontos culturais carregados
                        <span id="trail-status" style="margin-left: 10px; display: none;">
                            | <i class="fas fa-walking"></i> <span id="visited-points-count">0</span> visitados
                        </span>
                    </div>
                    <div style="opacity: 0.8;">
                        üåç Patrim√¥nio Afro-Brasileiro
                    </div>
                </div>
            </div>

            <!-- Audio Descri√ß√£o -->
            <div class="page-audio-description">
                <button class="audio-desc-btn" id="audio-desc-btn" title="Ouvir descri√ß√£o da p√°gina">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>

            <!-- Controle de voz -->
            <div class="voice-control">
                <button class="voice-btn" id="voice-control-btn" title="Ativar/Desativar √°udio autom√°tico">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Vari√°veis globais
        let map;
        let roteiroAfroCultural = { points: [] };
        let allMarkers = [];
        let currentMapStyle = 'voyager';
        let isRecordingTrail = false;
        let visitedPoints = new Set();
        let trailCoordinates = [];
        let trailLines = [];
        let speechSynthesis = window.speechSynthesis;
        let isVoiceEnabled = true;
        let currentUtterance = null;
        let pendingPopup = null; // Pop-up que est√° esperando a linha chegar
        
        // COORDENADAS CENTRO CAMPOS
        const CENTRO_CAMPOS = [-21.7580735, -41.3322809];
        const ZOOM_INICIAL = 15;
        
        // Estilos de mapa
        const mapStyles = {
            'voyager': {
                name: 'Sat√©lite Art√≠stico',
                layer: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CARTO',
                    maxZoom: 19,
                    subdomains: 'abcd'
                })
            },
            'terrain': {
                name: 'Relevo 3D',
                layer: L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
                    attribution: 'Map tiles by Stamen Design, CC BY 3.0',
                    maxZoom: 18,
                    subdomains: 'abcd'
                })
            },
            'topographic': {
                name: 'Topogr√°fico',
                layer: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: ¬© OpenStreetMap contributors, SRTM | Map style: ¬© OpenTopoMap',
                    maxZoom: 17
                })
            },
            'dark': {
                name: 'Modo Escuro',
                layer: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap ¬© CARTO',
                    maxZoom: 19,
                    subdomains: 'abcd'
                })
            }
        };
        
        // √çcones
        const normalIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        
        const highlightedIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        
        const visitedIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        
        // Inicializar mapa
        function initializeMap() {
            try {
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    zoomAnimation: true,
                    fadeAnimation: true
                }).setView(CENTRO_CAMPOS, ZOOM_INICIAL);
                
                mapStyles[currentMapStyle].layer.addTo(map);
                
                L.control.zoom({
                    position: 'bottomright'
                }).addTo(map);
                
                L.control.scale({
                    imperial: false,
                    metric: true,
                    position: 'bottomleft'
                }).addTo(map);
                
                // Redimensionar mapa
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                map.whenReady(() => {
                    console.log('Mapa carregado com sucesso');
                    map.invalidateSize();
                    document.getElementById('loading').style.display = 'none';
                    
                    // Reproduzir descri√ß√£o inicial
                    setTimeout(() => {
                        readPageDescription();
                    }, 1000);
                });
                
                return true;
            } catch (error) {
                console.error('Erro ao inicializar mapa:', error);
                showError('Erro ao carregar o mapa. Tente recarregar a p√°gina.');
                return false;
            }
        }
        
        // Carregar pontos
        async function loadPoints() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbxJCCJtZeVCkdncRnL5JG4ZUCQQhtoZIuLzBQHSbQ7QVMm_zms7HTWNrwb0N5wdDGJ9FA/exec');
                
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                const pontos = await response.json();
                
                if (!pontos || !Array.isArray(pontos)) {
                    throw new Error('Formato de dados inv√°lido');
                }
                
                roteiroAfroCultural.points = pontos.map((ponto, index) => ({
                    id: index,
                    nome: ponto.Nome || ponto.nome,
                    lat: parseFloat(ponto.Latitude || ponto.lat),
                    lng: parseFloat(ponto.Longitude || ponto.lng),
                    descricao: ponto.Descri√ß√£o || ponto.descricao,
                    endereco: ponto.Endere√ßo || ponto.endereco || 'Endere√ßo n√£o informado',
                    img: ponto.Imagem || ponto.img,
                    visited: false
                })).filter(ponto => {
                    return ponto.nome && !isNaN(ponto.lat) && !isNaN(ponto.lng);
                });
                
                if (roteiroAfroCultural.points.length === 0) {
                    throw new Error('Nenhum ponto v√°lido encontrado');
                }
                
                addPointsToMap();
                createPointsList();
                updatePointsCount();
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                loadExampleData();
            }
        }
        
        // Adicionar pontos ao mapa
        function addPointsToMap() {
            if (!map) return;
            
            allMarkers.forEach(marker => map.removeLayer(marker));
            allMarkers = [];
            
            roteiroAfroCultural.points.forEach(ponto => {
                try {
                    const marker = L.marker([ponto.lat, ponto.lng], {
                        icon: normalIcon
                    }).addTo(map);
                    
                    let popupContent = `
                        <div class="custom-popup">
                            <div class="popup-header">
                                <div class="popup-header-content">
                                    <div class="popup-title-container">
                                        <div class="popup-title">${ponto.nome}</div>
                                        <div class="popup-address">${ponto.endereco}</div>
                                    </div>
                                    <div class="popup-controls">
                                        <button class="popup-audio-btn" data-point-id="${ponto.id}" title="Ouvir descri√ß√£o">
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                    `;
                    
                    if (ponto.img) {
                        popupContent += `
                            <div class="popup-image-container">
                                <img src="${ponto.img}" class="popup-image" alt="${ponto.nome}" onerror="this.style.display='none'">
                            </div>
                        `;
                    }
                    
                    if (ponto.descricao) {
                        popupContent += `
                            <div class="popup-body">
                                <div class="popup-description">${ponto.descricao}</div>
                            </div>
                        `;
                    }
                    
                    popupContent += `</div>`;
                    
                    marker.bindPopup(popupContent, {
                        minWidth: 320,
                        maxWidth: 400,
                        className: 'custom-popup-wrapper',
                        maxHeight: 500
                    });
                    
                    marker.on('click', () => {
                        if (isRecordingTrail) {
                            // Marcar ponto como visitado ANTES de mostrar popup
                            visitPoint(ponto.id, marker);
                        } else {
                            // Se n√£o estiver em modo trilha, mostrar popup normal
                            marker.openPopup();
                        }
                    });
                    
                    marker.on('popupopen', () => {
                        const audioBtn = document.querySelector(`.popup-audio-btn[data-point-id="${ponto.id}"]`);
                        if (audioBtn) {
                            audioBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                readDescription(ponto);
                            });
                        }
                        
                        if (isVoiceEnabled) {
                            setTimeout(() => {
                                readDescription(ponto);
                            }, 500);
                        }
                    });
                    
                    marker.on('popupclose', () => {
                        stopReading();
                    });
                    
                    allMarkers.push(marker);
                } catch (error) {
                    console.error('Erro ao adicionar marcador:', error);
                }
            });
        }
        
        // Visitar ponto (modo trilha)
        function visitPoint(pointId, marker) {
            const ponto = roteiroAfroCultural.points.find(p => p.id === pointId);
            if (!ponto || visitedPoints.has(pointId)) return;
            
            // Marcar como visitado
            ponto.visited = true;
            visitedPoints.add(pointId);
            
            // Atualizar marcador
            marker.setIcon(visitedIcon);
            
            // Atualizar item na lista
            const pointItem = document.querySelector(`.point-item[data-id="${pointId}"]`);
            if (pointItem) {
                pointItem.classList.add('visited');
            }
            
            // Adicionar coordenada √† trilha
            trailCoordinates.push([ponto.lat, ponto.lng]);
            
            // **SEQU√äNCIA CORRETA: Linha primeiro, depois popup**
            if (trailCoordinates.length >= 2) {
                // Desenhar linha animada
                drawAnimatedLine(() => {
                    // S√ì DEPOIS que a linha terminar, abrir popup
                    setTimeout(() => {
                        marker.openPopup();
                    }, 300);
                });
            } else {
                // Primeiro ponto, abrir popup imediatamente
                setTimeout(() => {
                    marker.openPopup();
                }, 500);
            }
            
            // Atualizar contador
            updateVisitedCount();
            
            // Mostrar notifica√ß√£o
            showNotification(`Ponto "${ponto.nome}" registrado na sua trilha!`);
        }
        
        // Desenhar linha animada
        function drawAnimatedLine(callback) {
            if (trailCoordinates.length < 2) return;
            
            // Remover linhas antigas
            trailLines.forEach(line => map.removeLayer(line));
            trailLines = [];
            
            const start = trailCoordinates[trailCoordinates.length - 2];
            const end = trailCoordinates[trailCoordinates.length - 1];
            
            // Criar linha com anima√ß√£o de tra√ßos
            const line = L.polyline([start, end], {
                color: '#e87722',
                weight: window.innerWidth <= 768 ? 5 : 4,
                opacity: 0.9,
                dashArray: window.innerWidth <= 768 ? '8,12' : '10,15',
                lineCap: 'round',
                className: 'pure-trail-line animating'
            }).addTo(map);
            
            trailLines.push(line);
            
            // Quando a anima√ß√£o terminar, executar callback
            setTimeout(() => {
                if (callback) callback();
            }, 1500);
        }
        
        // Ler descri√ß√£o da p√°gina
        function readPageDescription() {
            if (!speechSynthesis) return;
            
            stopReading();
            
            const text = `Bem-vindo ao Mapa Sat√©lite Art√≠stico dos Afro-Roteiros de Campos dos Goytacazes. Explore os pontos culturais afro-brasileiros da cidade.`;
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = 0.9;
            
            const audioDescBtn = document.getElementById('audio-desc-btn');
            if (audioDescBtn) audioDescBtn.classList.add('speaking');
            
            currentUtterance.onend = () => {
                if (audioDescBtn) audioDescBtn.classList.remove('speaking');
                currentUtterance = null;
            };
            
            speechSynthesis.speak(currentUtterance);
        }
        
        // Ler descri√ß√£o
        function readDescription(ponto) {
            stopReading();
            
            if (!speechSynthesis) return;
            
            const text = `${ponto.nome}. ${ponto.descricao}. Endere√ßo: ${ponto.endereco}`;
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = 0.9;
            
            const audioBtn = document.querySelector(`.popup-audio-btn[data-point-id="${ponto.id}"]`);
            const voiceBtn = document.getElementById('voice-control-btn');
            
            if (audioBtn) audioBtn.classList.add('speaking');
            if (voiceBtn) voiceBtn.classList.add('speaking');
            
            currentUtterance.onend = () => {
                if (audioBtn) audioBtn.classList.remove('speaking');
                if (voiceBtn) voiceBtn.classList.remove('speaking');
                currentUtterance = null;
            };
            
            speechSynthesis.speak(currentUtterance);
        }
        
        // Parar leitura
        function stopReading() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            document.querySelectorAll('.popup-audio-btn.speaking').forEach(btn => {
                btn.classList.remove('speaking');
            });
            
            const audioDescBtn = document.getElementById('audio-desc-btn');
            if (audioDescBtn) audioDescBtn.classList.remove('speaking');
            
            const voiceBtn = document.getElementById('voice-control-btn');
            if (voiceBtn) voiceBtn.classList.remove('speaking');
            
            currentUtterance = null;
        }
        
        // Toggle controle de voz
        function toggleVoiceControl() {
            isVoiceEnabled = !isVoiceEnabled;
            const voiceBtn = document.getElementById('voice-control-btn');
            
            if (isVoiceEnabled) {
                voiceBtn.classList.remove('disabled');
                voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                voiceBtn.title = 'Desativar √°udio autom√°tico';
                showNotification('√Åudio autom√°tico ativado');
            } else {
                voiceBtn.classList.add('disabled');
                voiceBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                voiceBtn.title = 'Ativar √°udio autom√°tico';
                showNotification('√Åudio autom√°tico desativado');
                stopReading();
            }
        }
        
        // Criar lista de pontos
        function createPointsList() {
            const pointsList = document.getElementById('points-list');
            pointsList.innerHTML = '';
            
            roteiroAfroCultural.points.forEach(ponto => {
                const pointItem = document.createElement('div');
                pointItem.className = 'point-item';
                pointItem.dataset.id = ponto.id;
                
                pointItem.innerHTML = `
                    <div class="point-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="point-info">
                        <div class="point-name">${ponto.nome}</div>
                        <div class="point-address">${ponto.endereco}</div>
                    </div>
                `;
                
                pointItem.addEventListener('click', () => {
                    if (isRecordingTrail) {
                        const marker = allMarkers.find(m => 
                            m.getLatLng().lat === ponto.lat && 
                            m.getLatLng().lng === ponto.lng
                        );
                        if (marker) {
                            visitPoint(ponto.id, marker);
                        }
                    }
                    togglePointsPanel();
                });
                
                pointsList.appendChild(pointItem);
            });
        }
        
        // Atualizar contador de pontos
        function updatePointsCount() {
            document.getElementById('points-count').textContent = roteiroAfroCultural.points.length;
        }
        
        // Atualizar contador de pontos visitados
        function updateVisitedCount() {
            const visitedCount = visitedPoints.size;
            document.getElementById('visited-points-count').textContent = visitedCount;
            
            const trailStatus = document.getElementById('trail-status');
            if (isRecordingTrail) {
                trailStatus.style.display = 'inline';
            }
        }
        
        // Mostrar notifica√ß√£o
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Dados de exemplo
        function loadExampleData() {
            const pontosExemplo = [
                {
                    id: 0,
                    nome: "Centro Cultural Afro-Brasileiro",
                    lat: -21.75404,
                    lng: -41.32173,
                    descricao: "Espa√ßo dedicado √† cultura afro-brasileira.",
                    endereco: "Rua Principal, 123 - Centro",
                    img: "https://images.unsplash.com/photo-1594736797933-d0e8135a2260?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
                    visited: false
                }
            ];
            
            roteiroAfroCultural.points = pontosExemplo;
            addPointsToMap();
            createPointsList();
            updatePointsCount();
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                setTimeout(readPageDescription, 500);
            }, 500);
        }
        
        // Mostrar erro
        function showError(message) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.innerHTML = `
                <div style="text-align: center; color: #d32f2f;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                    <p style="margin-bottom: 20px; font-size: 1rem;">${message}</p>
                    <button onclick="location.reload()" style="background: #e87722; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                        <i class="fas fa-redo"></i> Recarregar
                    </button>
                </div>
            `;
        }
        
        // FUN√á√ÉO DA TRILHA
        function toggleTrail() {
            if (!roteiroAfroCultural.points.length) {
                alert('Carregue os pontos primeiro!');
                return;
            }
            
            if (!isRecordingTrail) {
                // Iniciar trilha
                isRecordingTrail = true;
                visitedPoints.clear();
                trailCoordinates = [];
                
                trailLines.forEach(line => map.removeLayer(line));
                trailLines = [];
                
                roteiroAfroCultural.points.forEach(p => p.visited = false);
                allMarkers.forEach(marker => marker.setIcon(normalIcon));
                document.querySelectorAll('.point-item').forEach(item => item.classList.remove('visited'));
                
                document.getElementById('show-trail').classList.add('active');
                document.getElementById('trail-status').style.display = 'inline';
                updateVisitedCount();
                
                showNotification('Trilha iniciada! Clique nos pontos para registrar sua visita.');
            } else {
                // Parar trilha
                if (visitedPoints.size > 0) {
                    showTrailModal();
                } else {
                    isRecordingTrail = false;
                    document.getElementById('show-trail').classList.remove('active');
                    document.getElementById('trail-status').style.display = 'none';
                    showNotification('Trilha interrompida.');
                }
            }
        }
        
        // Mostrar modal da trilha
        function showTrailModal() {
            const modal = document.getElementById('trail-modal');
            const visitedCount = document.getElementById('visited-count');
            
            visitedCount.textContent = visitedPoints.size;
            
            const trailPointsList = document.getElementById('trail-points-list');
            trailPointsList.innerHTML = '';
            
            const visitedPointsList = roteiroAfroCultural.points
                .filter(p => p.visited)
                .map((ponto, index) => {
                    const item = document.createElement('div');
                    item.className = 'trail-point-item';
                    item.innerHTML = `
                        <div class="trail-point-number">${index + 1}</div>
                        <div class="trail-point-name">${ponto.nome}</div>
                    `;
                    return item;
                });
            
            visitedPointsList.forEach(item => trailPointsList.appendChild(item));
            
            modal.classList.add('active');
        }
        
        // Fechar modal
        function closeTrailModal() {
            const modal = document.getElementById('trail-modal');
            modal.classList.remove('active');
        }
        
        // Controles da interface
        function togglePointsPanel() {
            const panel = document.getElementById('points-panel');
            panel.classList.toggle('open');
            document.getElementById('toggle-points').classList.toggle('active', panel.classList.contains('open'));
            
            const controlsPanel = document.getElementById('map-controls-panel');
            if (controlsPanel.classList.contains('open')) {
                controlsPanel.classList.remove('open');
                document.getElementById('toggle-controls').classList.remove('active');
            }
        }
        
        function toggleControlsPanel() {
            const panel = document.getElementById('map-controls-panel');
            panel.classList.toggle('open');
            document.getElementById('toggle-controls').classList.toggle('active', panel.classList.contains('open'));
            
            const pointsPanel = document.getElementById('points-panel');
            if (pointsPanel.classList.contains('open')) {
                pointsPanel.classList.remove('open');
                document.getElementById('toggle-points').classList.remove('active');
            }
        }
        
        // Mudar estilo do mapa
        function changeMapStyle(style) {
            if (currentMapStyle === style) return;
            
            mapStyles[currentMapStyle].layer.remove();
            currentMapStyle = style;
            mapStyles[style].layer.addTo(map);
            
            document.querySelectorAll('.style-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.style === style) {
                    option.classList.add('active');
                }
            });
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            if (initializeMap()) {
                loadPoints();
            }
            
            // Configurar bot√µes
            document.getElementById('toggle-points').addEventListener('click', togglePointsPanel);
            document.getElementById('toggle-controls').addEventListener('click', toggleControlsPanel);
            document.getElementById('close-points-panel').addEventListener('click', togglePointsPanel);
            document.getElementById('show-trail').addEventListener('click', toggleTrail);
            document.getElementById('voice-control-btn').addEventListener('click', toggleVoiceControl);
            document.getElementById('audio-desc-btn').addEventListener('click', readPageDescription);
            
            // Configurar controles de estilo
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', () => {
                    changeMapStyle(option.dataset.style);
                });
            });
            
            // Bot√µes do modal
            document.getElementById('save-trail-btn').addEventListener('click', () => {
                showNotification('Funcionalidade PDF em desenvolvimento');
                closeTrailModal();
                isRecordingTrail = false;
                document.getElementById('show-trail').classList.remove('active');
                document.getElementById('trail-status').style.display = 'none';
            });
            
            document.getElementById('cancel-trail-btn').addEventListener('click', () => {
                closeTrailModal();
                isRecordingTrail = false;
                document.getElementById('show-trail').classList.remove('active');
                document.getElementById('trail-status').style.display = 'none';
                showNotification('Trilha encerrada sem salvar.');
            });
            
            document.getElementById('continue-trail-btn').addEventListener('click', () => {
                closeTrailModal();
                showNotification('Continuando trilha...');
            });
            
            // Redimensionar
            window.addEventListener('resize', () => {
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
            });
            
            // Verificar suporte a voz
            if (!speechSynthesis) {
                document.getElementById('voice-control-btn').classList.add('disabled');
                document.getElementById('voice-control-btn').title = 'Navegador n√£o suporta s√≠ntese de voz';
                document.getElementById('audio-desc-btn').classList.add('disabled');
                document.getElementById('audio-desc-btn').title = 'Navegador n√£o suporta s√≠ntese de voz';
            }
        });
    </script>
</body>
</html>